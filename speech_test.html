<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SpeechRecognition test (clear diagnostics)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 18px; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #ddd; background:#f7f7f7; margin: 0 8px 8px 0; }
    button { padding:10px 14px; border-radius:12px; border:1px solid #bbb; background:#fff; cursor:pointer; margin-right:8px; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    #banner { padding: 10px 12px; border-radius: 14px; border:1px solid #e8e8e8; background:#fff; margin: 10px 0 14px; }
    #final { border:1px solid #ddd; border-radius:12px; padding:10px; min-height:52px; font-size:18px; }
    #log { white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px;
           border:1px solid #eee; border-radius:12px; padding:10px; background:#fafafa; max-height:260px; overflow:auto; margin-top: 12px;}
  </style>
</head>
<body>
  <h2>SpeechRecognition test (clear diagnostics)</h2>

  <div>
    <span class="pill" id="uaPill"></span>
    <span class="pill" id="originPill"></span>
    <span class="pill" id="securePill"></span>
    <span class="pill" id="apiPill"></span>
    <span class="pill" id="resultsPill"></span>
  </div>

  <div id="banner"></div>

  <div>
    <button id="btnStart">üé§ Start</button>
    <button id="btnStop" disabled>‚èπ Stop</button>
    <button id="btnClear">üßπ Clear</button>
  </div>

  <div style="margin-top:12px;">
    <div style="margin:8px 0 6px; color:#666;">Final:</div>
    <div id="final"></div>
  </div>

  <div id="log"></div>

<script>
(() => {
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;

  const uaPill = document.getElementById('uaPill');
  const originPill = document.getElementById('originPill');
  const securePill = document.getElementById('securePill');
  const apiPill = document.getElementById('apiPill');
  const resultsPill = document.getElementById('resultsPill');

  const banner = document.getElementById('banner');
  const logEl = document.getElementById('log');
  const finalEl = document.getElementById('final');

  const btnStart = document.getElementById('btnStart');
  const btnStop = document.getElementById('btnStop');
  const btnClear = document.getElementById('btnClear');

  let recognition = null;
  let resultsCount = 0;

  function now() { return new Date().toLocaleTimeString(); }
  function log(msg) {
    logEl.textContent += `[${now()}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function detectBrowser(ua) {
    const isSamsung = /SamsungBrowser\//i.test(ua);
    const isCriOS = /CriOS\//i.test(ua); // iOS Chrome
    const isChrome = /Chrome\//i.test(ua) && !isSamsung;
    const isWebView = /; wv\)/i.test(ua) || /Version\/\d+\.\d+ Chrome\/\d+/i.test(ua) && /Mobile/i.test(ua) && !/Safari\/\d+/i.test(ua);
    if (isSamsung) return "Samsung Internet (SamsungBrowser)";
    if (isWebView) return "Android WebView (in-app browser)";
    if (isCriOS) return "Chrome on iOS (CriOS)";
    if (isChrome) return "Google Chrome";
    return "Unknown/Other";
  }

  function setPills() {
    const ua = navigator.userAgent;
    uaPill.textContent = `Browser: ${detectBrowser(ua)}`;
    originPill.textContent = `origin: ${location.origin}`;
    securePill.textContent = `secure: ${window.isSecureContext}`;
    apiPill.textContent = `SpeechRecognition: ${SpeechRec ? "YES" : "NO"}`;
    resultsPill.textContent = `results: ${resultsCount}`;
  }

  setPills();

  if (!window.isSecureContext) {
    banner.textContent = "‚ö†Ô∏è –ù–µ secure context (–Ω—É–∂–µ–Ω https). –ù–∞ GitHub Pages –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å https.";
  } else if (!SpeechRec) {
    banner.textContent = "‚ö†Ô∏è SpeechRecognition API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.";
  } else {
    banner.textContent = "‚úÖ –ù–∞–∂–º–∏ Start ‚Üí —Å–∫–∞–∂–∏ —Ñ—Ä–∞–∑—É ‚Üí –∑–∞–º–æ–ª—á–∏. –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –æ–Ω –ø–æ—è–≤–∏—Ç—Å—è –≤ Final –∏ —É–≤–µ–ª–∏—á–∏—Ç—Å—è —Å—á—ë—Ç—á–∏–∫ results.";
  }

  function setUI(running) {
    btnStart.disabled = running;
    btnStop.disabled = !running;
  }

  btnStart.addEventListener('click', () => {
    if (!SpeechRec) { log("SpeechRecognition API not available"); return; }
    try {
      recognition = new SpeechRec();
      recognition.lang = "ru-RU";
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = () => log("onstart");
      recognition.onaudiostart = () => log("onaudiostart");
      recognition.onspeechstart = () => log("onspeechstart");
      recognition.onspeechend = () => log("onspeechend");
      recognition.onend = () => { log("onend"); setUI(false); };
      recognition.onerror = (e) => { log(`onerror: ${e.error}${e.message ? (" | " + e.message) : ""}`); setUI(false); };

      recognition.onresult = (event) => {
        resultsCount++;
        setPills();
        const text = (event.results?.[0]?.[0]?.transcript || "").trim();
        log(`onresult: "${text}"`);
        if (text) finalEl.textContent = text;
      };

      recognition.start();
      setUI(true);
      log("Called recognition.start()");
    } catch (e) {
      log("Exception: " + (e?.message || e));
      setUI(false);
    }
  });

  btnStop.addEventListener('click', () => {
    if (!recognition) return;
    try {
      recognition.stop();
      log("Called recognition.stop()");
    } catch (e) {
      log("Exception on stop: " + (e?.message || e));
    }
  });

  btnClear.addEventListener('click', () => {
    finalEl.textContent = "";
    logEl.textContent = "";
    resultsCount = 0;
    setPills();
    log("Cleared.");
  });

  log("Page loaded. UserAgent: " + navigator.userAgent);
})();
</script>
</body>
</html>
