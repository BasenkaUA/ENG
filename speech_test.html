<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SpeechRecognition test (GitHub Pages)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 18px; line-height: 1.35; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .card { border: 1px solid #e8e8e8; border-radius: 16px; padding: 12px; background:#fff; }
    button, select, input[type="checkbox"] + label { font-size: 14px; }
    button { padding: 10px 14px; border-radius: 12px; border: 1px solid #bbb; background: #fff; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    select { padding: 9px 10px; border-radius: 12px; border:1px solid #bbb; background:#fff; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; border:1px solid #ddd; background:#f7f7f7; }
    #final { font-size: 18px; padding: 10px; border: 1px solid #ddd; border-radius: 12px; min-height: 52px; }
    #interim { color: #666; padding: 8px 10px; border: 1px dashed #ddd; border-radius: 12px; min-height: 34px; }
    #log { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px;
           border: 1px solid #eee; border-radius: 12px; padding: 10px; background: #fafafa; max-height: 280px; overflow:auto; }
    .warn { color: #b45309; }
    .err { color: #b91c1c; }
    .ok { color: #15803d; }
    .muted { color:#666; font-size: 13px; }
    .divider { height: 1px; background:#eee; margin: 12px 0; }
  </style>
</head>
<body>
  <h2>SpeechRecognition test (GitHub Pages / HTTPS)</h2>

  <div class="row" style="margin-bottom:10px;">
    <span class="pill" id="securePill">secure?</span>
    <span class="pill" id="originPill">origin</span>
    <span class="pill" id="apiPill">SpeechRecognition?</span>
  </div>

  <div class="card" style="margin-bottom:12px;">
    <div class="row">
      <div>
        <div class="muted">Language</div>
        <select id="lang">
          <option value="ru-RU">ru-RU (Russian)</option>
          <option value="en-US" selected>en-US (English US)</option>
          <option value="en-GB">en-GB (English UK)</option>
          <option value="es-ES">es-ES (Spanish)</option>
          <option value="fr-FR">fr-FR (French)</option>
          <option value="de-DE">de-DE (German)</option>
          <option value="it-IT">it-IT (Italian)</option>
        </select>
      </div>

      <div>
        <div class="muted">Mode</div>
        <select id="mode">
          <option value="phrase" selected>One phrase (recommended)</option>
          <option value="continuous">Continuous</option>
        </select>
      </div>

      <div>
        <div class="muted">Interim results</div>
        <select id="interimSel">
          <option value="off" selected>Off</option>
          <option value="on">On</option>
        </select>
      </div>

      <div>
        <div class="muted">Auto-abort if no events</div>
        <select id="abortDelay">
          <option value="0">Off</option>
          <option value="5000">5s</option>
          <option value="8000" selected>8s</option>
          <option value="12000">12s</option>
        </select>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <button id="btnStart">üé§ Start</button>
      <button id="btnStop" disabled>‚èπ Stop</button>
      <button id="btnAbort" disabled>üõë Abort</button>
      <button id="btnClear">üßπ Clear</button>
      <button id="btnMicPerm">üéô Check mic permission</button>
    </div>

    <p id="hint" class="warn" style="margin:10px 0 0;"></p>
  </div>

  <div class="card" style="margin-bottom:12px;">
    <div style="margin: 0 0 6px;" class="muted">Final:</div>
    <div id="final"></div>

    <div style="margin: 12px 0 6px;" class="muted">Interim:</div>
    <div id="interim"></div>
  </div>

  <div class="card">
    <div style="margin: 0 0 6px;" class="muted">Log:</div>
    <div id="log"></div>
  </div>

<script>
(() => {
  const logEl = document.getElementById('log');
  const finalEl = document.getElementById('final');
  const interimEl = document.getElementById('interim');
  const hintEl = document.getElementById('hint');

  const btnStart = document.getElementById('btnStart');
  const btnStop = document.getElementById('btnStop');
  const btnAbort = document.getElementById('btnAbort');
  const btnClear = document.getElementById('btnClear');
  const btnMicPerm = document.getElementById('btnMicPerm');

  const langSel = document.getElementById('lang');
  const modeSel = document.getElementById('mode');
  const interimSel = document.getElementById('interimSel');
  const abortDelaySel = document.getElementById('abortDelay');

  const securePill = document.getElementById('securePill');
  const originPill = document.getElementById('originPill');
  const apiPill = document.getElementById('apiPill');

  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;

  function now() {
    return new Date().toLocaleTimeString();
  }

  function log(msg) {
    logEl.textContent += `[${now()}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  // Environment info
  securePill.textContent = `isSecureContext: ${window.isSecureContext}`;
  originPill.textContent = `origin: ${location.origin}`;
  apiPill.textContent = `SpeechRecognition: ${SpeechRec ? "YES" : "NO"}`;

  if (!window.isSecureContext) {
    hintEl.textContent = "‚ö†Ô∏è –ù–µ secure context. Web Speech –æ–±—ã—á–Ω–æ —Ç—Ä–µ–±—É–µ—Ç https. GitHub Pages = https.";
  } else if (!SpeechRec) {
    hintEl.textContent = "‚ö†Ô∏è –í —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –Ω–µ—Ç SpeechRecognition/webkitSpeechRecognition. –ü–æ–ø—Ä–æ–±—É–π Chrome/Edge (desktop).";
  } else {
    hintEl.textContent = "‚úÖ API –Ω–∞–π–¥–µ–Ω. –ù–∞–∂–º–∏ Start, —Å–∫–∞–∂–∏ —Ñ—Ä–∞–∑—É 2‚Äì3 —Å–µ–∫ –∏ –∑–∞–º–æ–ª—á–∏ –Ω–∞ 2‚Äì4 —Å–µ–∫ (–æ—Å–æ–±–µ–Ω–Ω–æ –≤ —Ä–µ–∂–∏–º–µ One phrase).";
    hintEl.className = "ok";
  }

  let recognition = null;
  let running = false;
  let killTimer = null;

  function setUI(isRunning) {
    running = isRunning;
    btnStart.disabled = isRunning;
    btnStop.disabled = !isRunning;
    btnAbort.disabled = !isRunning;
    langSel.disabled = isRunning;
    modeSel.disabled = isRunning;
    interimSel.disabled = isRunning;
    abortDelaySel.disabled = isRunning;
  }

  function clearKillTimer() {
    if (killTimer) {
      clearTimeout(killTimer);
      killTimer = null;
    }
  }

  function armKillTimer() {
    clearKillTimer();
    const delay = Number(abortDelaySel.value || 0);
    if (!delay) return;

    killTimer = setTimeout(() => {
      if (!recognition) return;
      try {
        log(`No result/error/end after ${delay/1000}s ‚Üí calling recognition.abort()`);
        recognition.abort();
      } catch (e) {
        log(`Exception on abort: ${e?.message || e}`);
      }
    }, delay);
  }

  function buildRecognition() {
    const r = new SpeechRec();

    // Settings
    r.lang = langSel.value;
    const mode = modeSel.value;
    const interimOn = interimSel.value === "on";

    if (mode === "phrase") {
      r.continuous = false;
      r.interimResults = false;  // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ "—á–∏—Å—Ç—ã–π" —Ç–µ—Å—Ç
    } else {
      r.continuous = true;
      r.interimResults = interimOn;
    }

    r.maxAlternatives = 3;

    // Event logging
    r.onstart = () => { log("onstart: recognition started"); };
    r.onaudiostart = () => { log("onaudiostart"); };
    r.onsoundstart = () => { log("onsoundstart"); };
    r.onspeechstart = () => { log("onspeechstart"); };
    r.onspeechend = () => { log("onspeechend"); };
    r.onsoundend = () => { log("onsoundend"); };
    r.onaudioend = () => { log("onaudioend"); };

    r.onnomatch = () => {
      log("onnomatch: speech detected but not recognized");
      clearKillTimer();
    };

    r.onresult = (event) => {
      clearKillTimer();

      let interim = "";
      let final = "";

      for (let i = event.resultIndex; i < event.results.length; i++) {
        const res = event.results[i];
        const top = res[0];
        const text = (top?.transcript || "").trim();
        const conf = top?.confidence;

        if (!text) continue;

        if (res.isFinal) {
          final += (final ? " " : "") + text;
          log(`onresult FINAL: "${text}" (confidence: ${Number.isFinite(conf) ? conf.toFixed(3) : "n/a"})`);
        } else {
          interim += (interim ? " " : "") + text;
        }
      }

      if (interim) interimEl.textContent = interim;
      if (final) {
        finalEl.textContent = (finalEl.textContent ? (finalEl.textContent + " ") : "") + final;
        interimEl.textContent = "";
      }
    };

    r.onerror = (event) => {
      clearKillTimer();
      log(`onerror: ${event.error}${event.message ? (" | " + event.message) : ""}`);
      setUI(false);
    };

    r.onend = () => {
      clearKillTimer();
      log("onend: recognition ended");
      setUI(false);
    };

    return r;
  }

  btnStart.addEventListener("click", () => {
    if (!SpeechRec) { log("SpeechRecognition API not available"); return; }

    // Clear interim each start (final –Ω–µ —á–∏—Å—Ç–∏–º, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ)
    interimEl.textContent = "";

    try {
      recognition = buildRecognition();
      recognition.start();
      setUI(true);
      log("Called recognition.start()");
      armKillTimer();
    } catch (e) {
      clearKillTimer();
      log("Exception on start: " + (e?.message || e));
      setUI(false);
    }
  });

  btnStop.addEventListener("click", () => {
    if (!recognition) return;
    try {
      log("Called recognition.stop()");
      recognition.stop();
      // stop() –º–æ–∂–µ—Ç –∂–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è ‚Äî killTimer –ø—É—Å—Ç—å –µ—â—ë –Ω–µ–º–Ω–æ–≥–æ –ø–æ–∂–∏–≤—ë—Ç
      armKillTimer();
    } catch (e) {
      log("Exception on stop: " + (e?.message || e));
    }
  });

  btnAbort.addEventListener("click", () => {
    if (!recognition) return;
    try {
      log("Called recognition.abort()");
      recognition.abort();
    } catch (e) {
      log("Exception on abort: " + (e?.message || e));
    }
  });

  btnClear.addEventListener("click", () => {
    finalEl.textContent = "";
    interimEl.textContent = "";
    logEl.textContent = "";
    log("Cleared.");
  });

  btnMicPerm.addEventListener("click", async () => {
    if (!navigator.mediaDevices?.getUserMedia) {
      log("getUserMedia not available in this browser");
      return;
    }
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      log("getUserMedia OK: microphone permission granted");
      stream.getTracks().forEach(t => t.stop());
    } catch (e) {
      log("getUserMedia ERROR: " + (e?.name || "") + " " + (e?.message || e));
    }
  });

  log("Page loaded. UserAgent: " + navigator.userAgent);
})();
</script>
</body>
</html>
